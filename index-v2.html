<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 è·¨è´¦æˆ·åŒæ­¥å¼•æ“ Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .box-card { margin-bottom: 20px; border-radius: 8px; }
        .header-actions { display: flex; justify-content: space-between; align-items: center; }
        
        /* åˆ—è¡¨é¡¹æ ·å¼ */
        .list-group { border: 1px solid #ebeef5; border-radius: 4px; padding: 10px; min-height: 100px; background: #fff; }
        .list-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
        .list-item:last-child { border-bottom: none; }
        .list-item-content { display: flex; align-items: center; gap: 10px; }
        
        .status-running { color: #67C23A; font-weight: bold; }
        .status-failed { color: #F56C6C; font-weight: bold; }
        .status-paused { color: #E6A23C; }

        /* ç›®å½•æµè§ˆæ ·å¼ */
        .dir-browser-list { max-height: 300px; overflow-y: auto; border: 1px solid #eee; margin-top: 10px; }
        .dir-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #f9f9f9; display: flex; align-items: center; }
        .dir-item:hover { background-color: #ecf5ff; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <h2 style="margin-bottom: 20px;">â˜ï¸ S3 è·¨è´¦æˆ·åŒæ­¥å¼•æ“ Pro</h2>

        <!-- é…ç½®åŒºåŸŸ -->
        <el-row :gutter="20">
            <!-- å·¦ä¾§ï¼šæºé…ç½® -->
            <el-col :span="10">
                <el-card class="box-card">
                    <template #header>
                        <div class="header-actions">
                            <span>ğŸ“¤ æºåˆ—è¡¨ (Sources)</span>
                            <el-button type="primary" size="small" @click="openAddDialog('source')">â• æ·»åŠ æº</el-button>
                        </div>
                    </template>
                    <div class="list-group">
                        <div v-if="sources.length === 0" style="text-align: center; color: #999; padding: 30px;">æš‚æ— æºï¼Œè¯·æ·»åŠ </div>
                        <div v-for="(item, idx) in sources" :key="idx" class="list-item">
                            <div class="list-item-content">
                                <el-tag size="small">{{ getAccName(item.account_id) }}</el-tag>
                                <span>{{ item.bucket }} / <b>{{ item.prefix }}</b></span>
                                <el-tag v-if="!item.prefix.endsWith('/') && item.prefix !== ''" type="warning" size="small" effect="plain">ä¿ç•™ç›®å½•å</el-tag>
                                <el-tag v-else type="info" size="small" effect="plain">ä»…å†…å®¹</el-tag>
                            </div>
                            <el-button type="danger" link icon="Delete" @click="sources.splice(idx, 1)"></el-button>
                        </div>
                    </div>
                </el-card>
            </el-col>

            <!-- ä¸­é—´ï¼šè¿æ¥çº¿ -->
            <el-col :span="4" style="text-align: center; padding-top: 80px;">
                <div style="font-size: 24px; color: #909399;">â¡ï¸ åŒæ­¥è‡³ â¡ï¸</div>
                <div style="margin-top: 10px; font-size: 12px; color: #999;">
                    æ¨¡å¼: {{ sources.length }}æº Ã— {{ dests.length }}ç›®æ ‡<br>
                    å°†ç”Ÿæˆ {{ sources.length * dests.length }} ä¸ªä»»åŠ¡
                </div>
                <el-button type="success" size="large" style="margin-top: 20px;" :disabled="sources.length === 0 || dests.length === 0" :loading="submitting" @click="submitAll">
                    ğŸš€ å¯åŠ¨å¼•æ“
                </el-button>
            </el-col>

            <!-- å³ä¾§ï¼šç›®æ ‡é…ç½® -->
            <el-col :span="10">
                <el-card class="box-card">
                    <template #header>
                        <div class="header-actions">
                            <span>ğŸ“¥ ç›®æ ‡åˆ—è¡¨ (Destinations)</span>
                            <el-button type="primary" size="small" @click="openAddDialog('dest')">â• æ·»åŠ ç›®æ ‡</el-button>
                        </div>
                    </template>
                    <div class="list-group">
                        <div v-if="dests.length === 0" style="text-align: center; color: #999; padding: 30px;">æš‚æ— ç›®æ ‡ï¼Œè¯·æ·»åŠ </div>
                        <div v-for="(item, idx) in dests" :key="idx" class="list-item">
                            <div class="list-item-content">
                                <el-tag type="success" size="small">{{ getAccName(item.account_id) }}</el-tag>
                                <span>{{ item.bucket }} / <b>{{ item.prefix }}</b></span>
                            </div>
                            <el-button type="danger" link icon="Delete" @click="dests.splice(idx, 1)"></el-button>
                        </div>
                    </div>
                </el-card>
            </el-col>
        </el-row>

        <!-- ä»»åŠ¡ç›‘æ§ -->
        <el-card class="box-card" style="margin-top: 20px;">
            <template #header>
                <div class="header-actions">
                    <span>ğŸ“‹ è¿è¡Œä»»åŠ¡ç›‘æ§</span>
                    <div style="display: flex; gap: 10px;">
                         <!-- è¿™é‡Œå¯ä»¥åŠ ç­›é€‰ -->
                        <el-button icon="Refresh" circle @click="loadTasks"></el-button>
                    </div>
                </div>
            </template>
            <el-table :data="tasks" style="width: 100%" stripe size="small">
                <el-table-column prop="created_at" label="åˆ›å»ºæ—¶é—´" width="150">
                    <template #default="scope">{{ formatDate(scope.row.created_at) }}</template>
                </el-table-column>
                <el-table-column label="æº (Src)" min-width="200">
                    <template #default="scope">
                        <div style="font-size:12px; color:#666;">{{ getAccName(scope.row.source_account_id) }}</div>
                        <!-- æ˜¾ç¤ºæ—¶æŠŠæœ€ç»ˆçš„æ ‡å‡†åŒ–è·¯å¾„å±•ç¤ºå‡ºæ¥ -->
                        <b>{{ scope.row.source_bucket }}/{{ scope.row.source_prefix }}</b>
                    </template>
                </el-table-column>
                <el-table-column label="ç›®æ ‡ (Dst)" min-width="200">
                    <template #default="scope">
                        <div style="font-size:12px; color:#666;">{{ getAccName(scope.row.dest_account_id) }}</div>
                        <b>{{ scope.row.dest_bucket }}/{{ scope.row.dest_prefix }}</b>
                    </template>
                </el-table-column>
                <el-table-column label="è¿›åº¦" width="180">
                    <template #default="scope">
                        <el-progress :percentage="calcPercent(scope.row)" :status="scope.row.status === 'failed' ? 'exception' : ''"></el-progress>
                        <div style="font-size: 10px; margin-top: 2px;">
                            OK: {{ scope.row.synced_objects }} | Skip: {{ scope.row.skipped_objects }} | Err: {{ scope.row.failed_objects }}
                        </div>
                    </template>
                </el-table-column>
                <el-table-column prop="status" label="çŠ¶æ€" width="80">
                    <template #default="scope">
                        <span :class="'status-' + scope.row.status">{{ scope.row.status }}</span>
                    </template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" width="100">
                    <template #default="scope">
                        <el-button v-if="scope.row.status === 'running'" type="danger" link size="small" @click="stopTask(scope.row.id)">åœæ­¢</el-button>
                        <el-button v-if="scope.row.failed_objects > 0" type="warning" link size="small" @click="showErrors(scope.row.id)">é”™è¯¯</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </el-card>

        <!-- æ·»åŠ å¯¹è¯æ¡† -->
        <el-dialog v-model="dialogVisible" :title="dialogType === 'source' ? 'æ·»åŠ æº' : 'æ·»åŠ ç›®æ ‡'" width="500px">
            <el-form :model="form" label-width="80px">
                <el-form-item label="è´¦æˆ·">
                    <el-select v-model="form.account_id" placeholder="é€‰æ‹©è´¦æˆ·" @change="loadBuckets" style="width: 100%">
                        <el-option v-for="acc in accounts" :key="acc.id" :label="acc.name" :value="acc.id"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="æ¡¶">
                    <el-select v-model="form.bucket" placeholder="é€‰æ‹©æ¡¶" filterable style="width: 100%">
                        <el-option v-for="b in buckets" :key="b" :label="b" :value="b"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="ç›®å½•">
                    <el-input v-model="form.prefix" placeholder="ä¾‹å¦‚: logs/ (ç•™ç©ºä¸ºå…¨æ¡¶)">
                        <template #append>
                            <el-button @click="openDirBrowser">é€‰æ‹©</el-button>
                        </template>
                    </el-input>
                    <div v-if="dialogType === 'source'" style="font-size: 12px; color: #909399; margin-top: 5px;">
                        ğŸ’¡ æç¤º: ä»¥ "/" ç»“å°¾ä»£è¡¨ä»…å¤åˆ¶å†…å®¹ï¼›ä¸ä»¥ "/" ç»“å°¾ä»£è¡¨å¤åˆ¶ç›®å½•æœ¬èº«ã€‚
                    </div>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="addToList">ç¡®å®šæ·»åŠ </el-button>
            </template>
        </el-dialog>
        
        <!-- ç›®å½•æµè§ˆå™¨ -->
        <el-dialog v-model="dirBrowserVisible" title="é€‰æ‹©S3ç›®å½•" width="500px">
            <div v-loading="loadingDirs">
                <div style="margin-bottom:10px; display: flex; align-items: center;">
                    <el-button size="small" @click="navUp" :disabled="!currentPath">â¬†ï¸ ä¸Šçº§</el-button>
                    <el-input size="small" v-model="currentPath" readonly style="margin-left: 10px;">
                        <template #prepend>å½“å‰: /</template>
                    </el-input>
                </div>
                
                <div class="dir-browser-list">
                    <div v-if="dirList.length === 0" style="padding: 20px; text-align: center; color: #ccc;">(æ— å­ç›®å½•)</div>
                    <div v-for="d in dirList" :key="d" class="dir-item" @click="enterDir(d)">
                        ğŸ“ {{ d.replace(currentPath, '') }}
                    </div>
                </div>
            </div>
            <template #footer>
                <div style="display:flex; justify-content: space-between; align-items: center;">
                    <!-- ä»…åœ¨é€‰æ‹©æºæ—¶æ˜¾ç¤ºæ­¤é€‰é¡¹ -->
                    <div v-if="dialogType === 'source'">
                        <el-checkbox v-model="keepDirName">ä¿ç•™ç›®å½•å (å»æ‰æœ«å°¾ /)</el-checkbox>
                    </div>
                    <div v-else></div> <!-- å ä½ -->
                    
                    <div>
                        <el-button @click="dirBrowserVisible = false">å–æ¶ˆ</el-button>
                        <el-button type="primary" @click="confirmDir">ç¡®å®šé€‰æ‹©</el-button>
                    </div>
                </div>
            </template>
        </el-dialog>

        <!-- é”™è¯¯è¯¦æƒ…å¼¹çª— -->
        <el-dialog v-model="errorDialogVisible" title="é”™è¯¯æ—¥å¿—" width="60%">
            <el-table :data="currentErrors" height="400" border>
                <el-table-column prop="timestamp" label="æ—¶é—´" width="160">
                    <template #default="scope">{{ formatDate(scope.row.timestamp) }}</template>
                </el-table-column>
                <el-table-column prop="key" label="Key" width="200"></el-table-column>
                <el-table-column prop="error_msg" label="é”™è¯¯ä¿¡æ¯"></el-table-column>
            </el-table>
        </el-dialog>

    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <script>
        const API_BASE = 'http://localhost:8080/api';
        const { createApp, ref, reactive, onMounted } = Vue;

        const app = createApp({
            setup() {
                // æ•°æ®çŠ¶æ€
                const sources = ref([]);
                const dests = ref([]);
                const accounts = ref([]);
                const tasks = ref([]);
                const submitting = ref(false);

                // å¼¹çª—çŠ¶æ€
                const dialogVisible = ref(false);
                const dialogType = ref('source'); // 'source' or 'dest'
                const buckets = ref([]);
                const form = reactive({ account_id: '', bucket: '', prefix: '' });

                // ç›®å½•æµè§ˆå™¨
                const dirBrowserVisible = ref(false);
                const loadingDirs = ref(false);
                const currentPath = ref('');
                const dirList = ref([]);
                const keepDirName = ref(false);

                // é”™è¯¯æ˜¾ç¤º
                const errorDialogVisible = ref(false);
                const currentErrors = ref([]);

                onMounted(() => {
                    loadAccounts();
                    loadTasks();
                    setInterval(loadTasks, 5000);
                });

                // --- åŸºç¡€åŠ è½½ ---
                const loadAccounts = async () => {
                    const res = await axios.get(`${API_BASE}/accounts`);
                    accounts.value = res.data;
                };

                const loadBuckets = async () => {
                    if (!form.account_id) return;
                    const res = await axios.get(`${API_BASE}/buckets?account_id=${form.account_id}`);
                    buckets.value = res.data;
                };

                const loadTasks = async () => {
                    const res = await axios.get(`${API_BASE}/tasks`);
                    tasks.value = res.data;
                };

                // --- æ·»åŠ å¼¹çª—é€»è¾‘ ---
                const openAddDialog = (type) => {
                    dialogType.value = type;
                    form.account_id = '';
                    form.bucket = '';
                    form.prefix = '';
                    buckets.value = [];
                    dialogVisible.value = true;
                };

                const addToList = () => {
                    if (!form.bucket) return ElementPlus.ElMessage.warning('è¯·é€‰æ‹©æ¡¶');
                    const item = { ...form };
                    if (dialogType.value === 'source') sources.value.push(item);
                    else dests.value.push(item);
                    dialogVisible.value = false;
                };

                // --- ç›®å½•æµè§ˆå™¨é€»è¾‘ ---
                const openDirBrowser = () => {
                    if (!form.bucket) return ElementPlus.ElMessage.warning('è¯·å…ˆé€‰æ‹©è´¦æˆ·å’Œæ¡¶');
                    currentPath.value = form.prefix || '';
                    keepDirName.value = false; // é»˜è®¤ä¸å‹¾é€‰
                    loadDirs();
                    dirBrowserVisible.value = true;
                };

                const loadDirs = async () => {
                    loadingDirs.value = true;
                    try {
                        const res = await axios.get(`${API_BASE}/directories`, {
                            params: {
                                account_id: form.account_id,
                                bucket: form.bucket,
                                prefix: currentPath.value
                            }
                        });
                        dirList.value = res.data || [];
                    } finally {
                        loadingDirs.value = false;
                    }
                };

                const enterDir = (d) => { currentPath.value = d; loadDirs(); };
                
                const navUp = () => {
                    const parts = currentPath.value.split('/').filter(p=>p);
                    parts.pop();
                    currentPath.value = parts.length ? parts.join('/') + '/' : '';
                    loadDirs();
                };

                const confirmDir = () => {
                    let finalPath = currentPath.value;
                    // å¦‚æœå‹¾é€‰äº†ä¿ç•™ç›®å½•åï¼Œä¸”è·¯å¾„ä»¥ / ç»“å°¾ï¼Œåˆ™å»æ‰å®ƒ
                    if (dialogType.value === 'source' && keepDirName.value && finalPath.endsWith('/')) {
                        finalPath = finalPath.slice(0, -1);
                    }
                    form.prefix = finalPath;
                    dirBrowserVisible.value = false;
                };

                // --- æäº¤æ‰€æœ‰ ---
                const submitAll = async () => {
                    submitting.value = true;
                    try {
                        const payload = {
                            sources: sources.value,
                            dests: dests.value,
                            concurrency: 50
                        };
                        const res = await axios.post(`${API_BASE}/tasks`, payload);
                        // éƒ¨åˆ†æˆåŠŸæˆ–å…¨éƒ¨æˆåŠŸ
                        if (res.data.errors && res.data.errors.length > 0) {
                            ElementPlus.ElMessage.warning(`éƒ¨åˆ†ä»»åŠ¡åˆ›å»ºå¤±è´¥: ${res.data.errors.join('; ')}`);
                        } else {
                            ElementPlus.ElMessage.success(res.data.message);
                        }
                        sources.value = []; // ä»…æ¸…ç©ºæºï¼Œä¿ç•™ç›®æ ‡é€šå¸¸æ–¹ä¾¿
                        loadTasks();
                    } catch (e) {
                        ElementPlus.ElMessage.error(e.response?.data?.error || 'æäº¤å¤±è´¥');
                    } finally {
                        submitting.value = false;
                    }
                };

                const stopTask = async (id) => {
                    await axios.post(`${API_BASE}/tasks/${id}/stop`);
                    ElementPlus.ElMessage.warning('å·²å‘é€åœæ­¢ä¿¡å·');
                    loadTasks();
                };
                
                const showErrors = async (id) => {
                    const res = await axios.get(`${API_BASE}/tasks/${id}/errors`);
                    currentErrors.value = res.data || [];
                    errorDialogVisible.value = true;
                };

                // è¾…åŠ©å‡½æ•°
                const getAccName = (id) => {
                    const acc = accounts.value.find(a => a.id === id);
                    return acc ? acc.name : id;
                };
                const formatDate = (s) => new Date(s).toLocaleString();
                const calcPercent = (row) => {
                    if (!row.total_objects) return 0;
                    return Math.min(100, Math.round((row.synced_objects + row.skipped_objects + row.failed_objects) / row.total_objects * 100));
                };

                return {
                    sources, dests, accounts, tasks, submitting,
                    dialogVisible, dialogType, buckets, form,
                    dirBrowserVisible, loadingDirs, currentPath, dirList, keepDirName,
                    errorDialogVisible, currentErrors,
                    openAddDialog, loadBuckets, addToList, openDirBrowser,
                    enterDir, navUp, confirmDir, submitAll, stopTask, showErrors,
                    loadTasks, getAccName, formatDate, calcPercent
                };
            }
        });
        
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component)
        }
        app.use(ElementPlus).mount('#app');
    </script>
</body>
</html>
