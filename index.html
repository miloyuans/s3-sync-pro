<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 è·¨è´¦æˆ·åŒæ­¥ Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <style>
        body { background-color: #f5f7fa; font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', Arial, sans-serif; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .box-card { margin-bottom: 20px; }
        .dir-browser { min-height: 300px; border: 1px solid #dcdfe6; border-radius: 4px; padding: 10px; }
        .dir-item { cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; }
        .dir-item:hover { background-color: #f0f9eb; }
        .dir-name { display: flex; align-items: center; gap: 8px; flex-grow: 1; }
        .status-running { color: #67C23A; font-weight: bold; }
        .status-failed { color: #F56C6C; font-weight: bold; }
        .status-paused { color: #E6A23C; font-weight: bold; }
        .tag-group { margin-top: 5px; display: flex; flex-wrap: wrap; gap: 5px; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <h1>â˜ï¸ S3 è·¨è´¦æˆ·åŒæ­¥ Pro</h1>

        <!-- åˆ›å»ºä»»åŠ¡ -->
        <el-card class="box-card">
            <template #header>
                <div class="card-header">
                    <span>ğŸš€ æ–°å»ºä»»åŠ¡</span>
                    <el-button type="primary" @click="submitTask" :loading="submitting">ğŸš€ å¼€å§‹åŒæ­¥</el-button>
                </div>
            </template>
            <el-form :model="form" label-width="120px">
                <el-row :gutter="40">
                    <!-- å·¦ä¾§ï¼šæº -->
                    <el-col :span="12">
                        <el-divider content-position="left">ğŸ“¤ æº (Source)</el-divider>
                        <el-form-item label="æºè´¦æˆ·">
                            <el-select v-model="form.source_account_id" placeholder="é€‰æ‹©æºè´¦æˆ·" @change="loadBuckets('source')" style="width: 100%">
                                <el-option v-for="acc in accounts" :key="acc.id" :label="acc.name + ' (' + acc.region + ')'" :value="acc.id"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="æºæ¡¶">
                            <el-select v-model="form.source_bucket" placeholder="é€‰æ‹©æºæ¡¶" filterable @change="onSourceBucketChange" style="width: 100%">
                                <el-option v-for="b in sourceBuckets" :key="b" :label="b" :value="b"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="æºç›®å½•">
                            <el-button @click="openDirBrowser" :disabled="!form.source_bucket">ğŸ“ é€‰æ‹©ç›®å½•</el-button>
                            <div class="tag-group" v-if="form.source_prefixes.length > 0">
                                <el-tag v-for="(p, index) in form.source_prefixes" :key="index" closable @close="removePrefix(index)">
                                    {{ p }}
                                </el-tag>
                            </div>
                            <div v-else style="color: #999; font-size: 12px; margin-top: 5px;">æœªé€‰æ‹©ï¼Œé»˜è®¤åŒæ­¥æ•´ä¸ªæ¡¶</div>
                        </el-form-item>
                    </el-col>

                    <!-- å³ä¾§ï¼šç›®æ ‡ -->
                    <el-col :span="12">
                        <el-divider content-position="left">ğŸ“¥ ç›®æ ‡ (Destination)</el-divider>
                        <el-form-item label="ç›®æ ‡è´¦æˆ·">
                            <el-select v-model="form.dest_account_id" placeholder="é€‰æ‹©ç›®æ ‡è´¦æˆ·" @change="loadBuckets('dest')" style="width: 100%">
                                <el-option v-for="acc in accounts" :key="acc.id" :label="acc.name + ' (' + acc.region + ')'" :value="acc.id"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="ç›®æ ‡æ¡¶">
                            <el-select v-model="form.dest_bucket" placeholder="é€‰æ‹©ç›®æ ‡æ¡¶" filterable style="width: 100%">
                                <el-option v-for="b in destBuckets" :key="b" :label="b" :value="b"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="ç›®æ ‡è·¯å¾„å‰ç¼€">
                            <el-input v-model="form.dest_prefix" :placeholder="destPlaceholder"></el-input>
                            <div style="color: #909399; font-size: 12px; line-height: 1.4; margin-top: 4px;">
                                <span v-if="form.source_prefixes.length > 1">å¤šç›®å½•æ¨¡å¼ï¼šåªèƒ½å¡«å‰ç¼€ï¼ˆå¦‚ 'backup/'ï¼‰ï¼Œæºç›®å½•å°†ä½œä¸ºå­ç›®å½•ä¿æŒç»“æ„ã€‚</span>
                                <span v-else>å•ç›®å½•æ¨¡å¼ï¼šç•™ç©ºåˆ™ä¿æŒåŸåï¼Œå¡«å€¼åˆ™é‡å‘½åç›®æ ‡æ–‡ä»¶å¤¹ã€‚</span>
                            </div>
                        </el-form-item>
                    </el-col>
                </el-row>
            </el-form>
        </el-card>

        <!-- ç›®å½•é€‰æ‹©å¼¹çª— -->
        <el-dialog v-model="dirDialogVisible" title="é€‰æ‹©æºç›®å½• (æ”¯æŒå¤šé€‰)" width="600px">
            <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                <el-button size="small" @click="navigateUp" :disabled="currentPath === ''">â¬†ï¸ è¿”å›ä¸Šçº§</el-button>
                <el-input size="small" v-model="currentPath" readonly style="flex-grow: 1;">
                    <template #prepend>å½“å‰è·¯å¾„: /</template>
                </el-input>
            </div>
            
            <div class="dir-browser" v-loading="loadingDirs">
                <div v-if="dirList.length === 0" style="text-align: center; color: #999; padding-top: 50px;">
                    æ²¡æœ‰å­ç›®å½• (æˆ–æƒé™ä¸è¶³)
                </div>
                <div v-for="dir in dirList" :key="dir" class="dir-item">
                    <div class="dir-name" @click="enterDir(dir)">
                        ğŸ“ {{ dir.replace(currentPath, '') }}
                    </div>
                    <el-button type="primary" size="small" plain @click="selectDir(dir)">â• æ·»åŠ </el-button>
                </div>
            </div>
            <template #footer>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>å·²é€‰: {{ form.source_prefixes.length }} ä¸ªç›®å½•</span>
                    <el-button @click="dirDialogVisible = false">å®Œæˆ</el-button>
                </div>
            </template>
        </el-dialog>

        <!-- ä»»åŠ¡åˆ—è¡¨ (ç®€åŒ–ç‰ˆ) -->
        <el-card class="box-card">
            <template #header><span>ğŸ“‹ ä»»åŠ¡åˆ—è¡¨</span></template>
            <el-table :data="tasks" stripe>
                <el-table-column prop="created_at" label="æ—¶é—´" width="160">
                    <template #default="scope">{{ formatDate(scope.row.created_at) }}</template>
                </el-table-column>
                <el-table-column label="æº -> ç›®æ ‡" min-width="300">
                    <template #default="scope">
                        <div><el-tag size="small">Src</el-tag> {{ scope.row.source_bucket }}/{{ scope.row.source_prefix }}</div>
                        <div style="margin-top:4px;"><el-tag size="small" type="success">Dst</el-tag> {{ scope.row.dest_bucket }}/{{ scope.row.dest_prefix }}</div>
                    </template>
                </el-table-column>
                <el-table-column prop="status" label="çŠ¶æ€" width="100">
                    <template #default="scope"><b :class="'status-' + scope.row.status">{{ scope.row.status }}</b></template>
                </el-table-column>
                <el-table-column label="è¿›åº¦" width="150">
                    <template #default="scope">
                        <small>æˆåŠŸ: {{ scope.row.synced_objects }} / å¤±è´¥: {{ scope.row.failed_objects }}</small>
                    </template>
                </el-table-column>
            </el-table>
        </el-card>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:8080/api';
        const { createApp, ref, reactive, computed, onMounted } = Vue;

        createApp({
            setup() {
                const accounts = ref([]);
                const sourceBuckets = ref([]);
                const destBuckets = ref([]);
                const tasks = ref([]);
                const submitting = ref(false);

                // ç›®å½•æµè§ˆå™¨ç›¸å…³
                const dirDialogVisible = ref(false);
                const loadingDirs = ref(false);
                const currentPath = ref("");
                const dirList = ref([]);

                const form = reactive({
                    source_account_id: '',
                    source_bucket: '',
                    source_prefixes: [], // æ•°ç»„ï¼Œæ”¯æŒå¤šé€‰
                    dest_account_id: '',
                    dest_bucket: '',
                    dest_prefix: ''
                });

                // åŠ¨æ€æç¤º
                const destPlaceholder = computed(() => {
                    if (form.source_prefixes.length > 1) return "å¯é€‰: è¾“å…¥ç»Ÿä¸€å‰ç¼€ (å¦‚ 'backup/')";
                    return "å¯é€‰: è¾“å…¥ç›®æ ‡ç›®å½•å (ç•™ç©ºä¿æŒåŒå)";
                });

                onMounted(() => {
                    loadAccounts();
                    loadTasks();
                    setInterval(loadTasks, 5000);
                });

                const loadAccounts = async () => {
                    const res = await axios.get(`${API_BASE}/accounts`);
                    accounts.value = res.data;
                };

                const loadBuckets = async (type) => {
                    const accId = type === 'source' ? form.source_account_id : form.dest_account_id;
                    if (!accId) return;
                    const res = await axios.get(`${API_BASE}/buckets?account_id=${accId}`);
                    if (type === 'source') sourceBuckets.value = res.data;
                    else destBuckets.value = res.data;
                };

                // æºæ¡¶æ”¹å˜æ—¶æ¸…ç©ºå·²é€‰ç›®å½•
                const onSourceBucketChange = () => {
                    form.source_prefixes = [];
                    currentPath.value = "";
                };

                // --- ç›®å½•æµè§ˆå™¨é€»è¾‘ ---
                const openDirBrowser = () => {
                    currentPath.value = "";
                    loadDirectories();
                    dirDialogVisible.value = true;
                };

                const loadDirectories = async () => {
                    loadingDirs.value = true;
                    try {
                        const res = await axios.get(`${API_BASE}/directories`, {
                            params: {
                                account_id: form.source_account_id,
                                bucket: form.source_bucket,
                                prefix: currentPath.value
                            }
                        });
                        dirList.value = res.data || [];
                    } catch (e) {
                        ElementPlus.ElMessage.error("åŠ è½½ç›®å½•å¤±è´¥: " + (e.response?.data?.error || e.message));
                    } finally {
                        loadingDirs.value = false;
                    }
                };

                const enterDir = (dir) => {
                    currentPath.value = dir;
                    loadDirectories();
                };

                const navigateUp = () => {
                    // ç§»é™¤æœ€åä¸€æ®µç›®å½•
                    const parts = currentPath.value.split('/').filter(p => p);
                    parts.pop();
                    currentPath.value = parts.length > 0 ? parts.join('/') + '/' : '';
                    loadDirectories();
                };

                const selectDir = (dir) => {
                    if (!form.source_prefixes.includes(dir)) {
                        form.source_prefixes.push(dir);
                        ElementPlus.ElMessage.success(`å·²æ·»åŠ : ${dir}`);
                    }
                };

                const removePrefix = (index) => {
                    form.source_prefixes.splice(index, 1);
                };

                // --- æäº¤ä»»åŠ¡ ---
                const submitTask = async () => {
                    if (!form.source_bucket || !form.dest_bucket) return ElementPlus.ElMessage.warning("è¯·è¡¥å…¨ä¿¡æ¯");
                    
                    submitting.value = true;
                    // å¦‚æœç”¨æˆ·æ²¡é€‰ç›®å½•ï¼Œé»˜è®¤ä¼ ç©ºå­—ç¬¦ä¸²ï¼ˆå…¨æ¡¶ï¼‰
                    const sources = form.source_prefixes.length > 0 ? form.source_prefixes : [""];
                    
                    let successCount = 0;
                    
                    // æ‰¹é‡åˆ›å»ºä»»åŠ¡
                    for (const srcPrefix of sources) {
                        // æ™ºèƒ½è®¡ç®—ç›®æ ‡è·¯å¾„
                        let finalDestPrefix = form.dest_prefix;
                        
                        if (sources.length > 1) {
                            // å¤šç›®å½•æ¨¡å¼ï¼šæºç›®å½•åä½œä¸ºå­ç›®å½•
                            // ä¾‹å¦‚ src="data/logs/", dest="backup/" -> æœ€ç»ˆç›®æ ‡ "backup/logs/"
                            const dirName = srcPrefix.split('/').filter(p=>p).pop() || "";
                            finalDestPrefix = form.dest_prefix + dirName + "/";
                        } else {
                            // å•ç›®å½•æ¨¡å¼ï¼šå¦‚æœç”¨æˆ·æ²¡å¡«ç›®æ ‡ï¼Œä¿æŒå’Œæºä¸€æ ·ï¼ˆå¦‚æœæ˜¯å…¨æ¡¶åˆ™ä¸ºç©ºï¼‰
                            if (!finalDestPrefix && srcPrefix) {
                                finalDestPrefix = srcPrefix;
                            }
                        }

                        // æ¸…ç† //
                        finalDestPrefix = finalDestPrefix.replace('//', '/');

                        const taskPayload = {
                            source_account_id: form.source_account_id,
                            source_bucket: form.source_bucket,
                            source_prefix: srcPrefix,
                            dest_account_id: form.dest_account_id,
                            dest_bucket: form.dest_bucket,
                            dest_prefix: finalDestPrefix,
                            concurrency: 50
                        };

                        try {
                            await axios.post(`${API_BASE}/tasks`, taskPayload);
                            successCount++;
                        } catch (e) {
                            ElementPlus.ElMessage.error(`ä»»åŠ¡ ${srcPrefix} åˆ›å»ºå¤±è´¥: ` + e.response?.data?.error);
                        }
                    }

                    submitting.value = false;
                    if (successCount > 0) {
                        ElementPlus.ElMessage.success(`æˆåŠŸåˆ›å»º ${successCount} ä¸ªä»»åŠ¡`);
                        form.source_prefixes = []; // é‡ç½®
                        loadTasks();
                    }
                };

                const loadTasks = async () => {
                    const res = await axios.get(`${API_BASE}/tasks`);
                    tasks.value = res.data;
                };

                const formatDate = (s) => new Date(s).toLocaleString();

                return {
                    accounts, sourceBuckets, destBuckets, tasks, form, submitting,
                    destPlaceholder,
                    // Dir Browser
                    dirDialogVisible, loadingDirs, currentPath, dirList,
                    openDirBrowser, enterDir, navigateUp, selectDir, removePrefix,
                    // Methods
                    loadBuckets, onSourceBucketChange, submitTask, formatDate
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
